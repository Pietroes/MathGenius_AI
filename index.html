<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MathGenius AI (~pes)</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        indigo: { 50: '#eef2ff', 100: '#e0e7ff', 500: '#6366f1', 600: '#4f46e5', 700: '#4338ca', 900: '#312e81' },
                        slate: { 800: '#1e293b', 900: '#0f172a', 950: '#020617' }
                    }
                }
            }
        }
    </script>

    <!-- 2. Librerie per Markdown e Matematica -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <!-- 3. Babel per JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- 4. GeoGebra Deploy -->
    <script src="https://www.geogebra.org/apps/deployggb.js"></script>

    <!-- 5. Import Map per React e Lucide -->
    <script type="importmap">
        {
          "imports": {
            "react": "https://esm.sh/react@18.2.0",
            "react-dom/client": "https://esm.sh/react-dom@18.2.0/client",
            "lucide-react": "https://esm.sh/lucide-react@0.292.0"
          }
        }
    </script>

    <style>
        /* Markdown Styles */
        .prose { font-size: 0.95rem; line-height: 1.6; }
        .prose p { margin-bottom: 0.75em; }
        .prose h1, .prose h2, .prose h3 { font-weight: 700; margin-top: 1.2em; margin-bottom: 0.5em; }
        .prose ul { list-style-type: disc; padding-left: 1.5em; margin-bottom: 1em; }
        .prose ol { list-style-type: decimal; padding-left: 1.5em; margin-bottom: 1em; }
        .prose strong { font-weight: 600; color: inherit; }
        .prose code { background: rgba(99, 102, 241, 0.1); color: #6366f1; padding: 0.2em 0.4em; border-radius: 0.25em; font-family: monospace; font-size: 0.9em; }
        .dark .prose code { color: #818cf8; background: rgba(99, 102, 241, 0.2); }
        
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
    </style>
</head>
<body class="bg-slate-50 text-slate-900 dark:bg-slate-950 dark:text-slate-100 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import React, { useState, useEffect, useRef } from 'react';
        import { createRoot } from 'react-dom/client';
        import { 
            Upload, Image as ImageIcon, Loader2, Play, Settings, Calculator, 
            CheckCircle, AlertCircle, Moon, Sun, Camera, Mic, PenTool, 
            X, RefreshCw, Eraser, MessageSquare, Send, ChevronDown, ChevronUp, 
            User, Bot, HelpCircle, ExternalLink, Key, Coffee, Youtube, 
            Globe, Link as LinkIcon, ShieldCheck
        } from 'lucide-react';

        // --- COMPONENTI UTILITY ---

        /* --- API KEY GUIDE COMPONENT --- */
        const ApiKeyGuide = ({ onClose, isDarkMode }) => {
            const steps = [
                { 
                    title: "1. Accesso a Google AI Studio", 
                    desc: "Vai su aistudio.google.com con il tuo account Google.", 
                    icon: <ExternalLink className="w-10 h-10 text-indigo-500" />,
                    img: "https://raw.githubusercontent.com/Pietroes/MathGenius/refs/heads/main/1tutorial.jpg" 
                },
                { 
                    title: "2. Ottieni Chiave", 
                    desc: "Clicca su 'Get API key' nel menu laterale.", 
                    icon: <Key className="w-10 h-10 text-indigo-500" />,
                    img: "https://raw.githubusercontent.com/Pietroes/MathGenius/refs/heads/main/2tutorial.jpg"
                },
                { 
                    title: "3. Crea Chiave", 
                    desc: "Premi 'Create API key'.", 
                    icon: <Play className="w-10 h-10 text-indigo-500" />,
                    img: "https://raw.githubusercontent.com/Pietroes/MathGenius/refs/heads/main/3tutorial.jpg"
                },
                { 
                    title: "4. Nuovo Progetto", 
                    desc: "Seleziona 'Create API key in new project'.", 
                    icon: <Settings className="w-10 h-10 text-indigo-500" />,
                    img: "https://raw.githubusercontent.com/Pietroes/MathGenius/refs/heads/main/4tutorial.jpg"
                },
                { 
                    title: "5. Copia", 
                    desc: "Copia la stringa generata e incollala qui.", 
                    icon: <CheckCircle className="w-10 h-10 text-indigo-500" />,
                    img: "https://raw.githubusercontent.com/Pietroes/MathGenius/refs/heads/main/5tutorial.jpg"
                }
            ];

            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
                <div className={`w-full max-w-lg max-h-[85vh] overflow-y-auto rounded-2xl shadow-2xl flex flex-col ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
                    <div className={`p-5 border-b sticky top-0 z-10 flex justify-between items-center ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-100'}`}>
                    <h2 className="text-xl font-bold flex items-center gap-2"><Key className="w-5 h-5 text-indigo-500" /> Guida API Key</h2>
                    <button onClick={onClose} className="p-2 rounded-full hover:bg-white/10"><X className="w-6 h-6" /></button>
                    </div>
                    <div className="p-6 space-y-8">
                    <div className={`p-4 rounded-xl text-sm border flex gap-3 ${isDarkMode ? 'bg-indigo-900/20 border-indigo-500/30 text-indigo-200' : 'bg-indigo-50 border-indigo-100 text-indigo-700'}`}>
                        <HelpCircle className="w-5 h-5 shrink-0 mt-0.5" />
                        <p><strong>Nota:</strong> L'uso è gratuito (Free of charge) per scopi personali.</p>
                    </div>
                    <div className="space-y-6">
                        {steps.map((step, idx) => (
                        <div key={idx} className="flex gap-4">
                            <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shrink-0 ${isDarkMode ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-700'}`}>{idx + 1}</div>
                            <div className="flex-1">
                                <h3 className="font-semibold">{step.title}</h3>
                                <p className={`text-sm mb-2 ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{step.desc}</p>
                                <div className={`rounded-lg border-2 border-dashed overflow-hidden ${isDarkMode ? 'border-slate-700 bg-slate-800/50' : 'border-slate-200 bg-slate-50'}`}>
                                    {step.img ? (
                                        <img src={step.img} alt={step.title} className="w-full h-auto object-cover" loading="lazy" onError={(e) => e.target.style.display='none'} />
                                    ) : (
                                        <div className="aspect-video flex items-center justify-center opacity-50">{step.icon}</div>
                                    )}
                                </div>
                            </div>
                        </div>
                        ))}
                    </div>
                    <div className="pt-4 flex justify-center sticky bottom-0 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent pb-4">
                        <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors shadow-lg shadow-indigo-500/30">Vai su Google AI Studio <ExternalLink className="w-4 h-4" /></a>
                    </div>
                    </div>
                </div>
                </div>
            );
        };

        /* --- SOLUTION DISPLAY --- */
        const SolutionDisplay = ({ content, isDarkMode }) => {
            const containerRef = useRef(null);

            useEffect(() => {
                if (containerRef.current && window.marked && window.renderMathInElement) {
                    const originalText = content || "";
                    
                    const mathMap = [];
                    const protectedText = originalText.replace(
                        /(\$\$[\s\S]*?\$\$|\\\[[\s\S]*?\\\]|\\\([\s\S]*?\\\)|(?<!\\)\$((?:\\.|[^$])*?)(?<!\\)\$)/g, 
                        (match) => {
                            const placeholder = `MATHPLACEHOLDER${mathMap.length}ENDMATH`;
                            mathMap.push(match);
                            return placeholder;
                        }
                    );

                    let html = window.marked.parse(protectedText);

                    mathMap.forEach((math, i) => {
                        html = html.replace(`MATHPLACEHOLDER${i}ENDMATH`, math);
                    });

                    containerRef.current.innerHTML = html;

                    window.renderMathInElement(containerRef.current, {
                        delimiters: [
                            {left: '$$', right: '$$', display: true},
                            {left: '$', right: '$', display: false},
                            {left: '\\(', right: '\\)', display: false},
                            {left: '\\[', right: '\\]', display: true}
                        ],
                        throwOnError: false,
                        errorColor: '#cc0000',
                    });
                }
            }, [content]);

            return (
                <div 
                    ref={containerRef} 
                    className={`prose ${isDarkMode ? 'prose-invert text-slate-200' : 'text-slate-800'} max-w-none break-words overflow-x-auto`}
                />
            );
        };

        /* --- LIVE TUTOR CHAT --- */
        const LiveTutorChat = ({ apiKey, contextSolution, isDarkMode, onClose }) => {
            const [messages, setMessages] = useState([{ role: 'assistant', text: 'Ciao! Sono il tuo Tutor. Hai dubbi sulla soluzione?' }]);
            const [inputText, setInputText] = useState('');
            const [loading, setLoading] = useState(false);
            const messagesEndRef = useRef(null);

            useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, loading]);

            const handleSend = async () => {
                if (!inputText.trim()) return;
                const userMsg = inputText;
                setInputText('');
                setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
                setLoading(true);
                try {
                    const conversationHistory = messages.map(m => `${m.role === 'user' ? 'Studente' : 'Tutor'}: ${m.text}`).join('\n');
                    const prompt = `Sei un tutor. CONTESTO: ${contextSolution} STORICO: ${conversationHistory} DOMANDA: ${userMsg} Rispondi chiaramente.`;
                    
                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                    });
                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);
                    const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
                    setMessages(prev => [...prev, { role: 'assistant', text: aiText || "Errore risposta vuota." }]);
                } catch (error) {
                    setMessages(prev => [...prev, { role: 'assistant', text: `Errore: ${error.message}` }]);
                } finally {
                    setLoading(false);
                }
            };

            const bgClass = isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200';
            return (
                <div className={`fixed inset-0 z-50 flex flex-col md:max-w-md md:left-auto md:right-0 md:shadow-2xl animate-in slide-in-from-bottom-10 md:slide-in-from-right-10 duration-300 ${isDarkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'}`}>
                    <div className={`flex items-center justify-between p-4 border-b ${bgClass}`}>
                        <div className="flex items-center gap-2"><h3 className="font-bold">Tutor Chat</h3></div>
                        <button onClick={onClose}><X className="w-5 h-5" /></button>
                    </div>
                    <div className="flex-1 overflow-y-auto p-4 space-y-4">
                        {messages.map((msg, idx) => (
                            <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[85%] p-3 rounded-2xl text-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : (isDarkMode ? 'bg-slate-800' : 'bg-white')} shadow-sm`}>
                                    <SolutionDisplay content={msg.text} isDarkMode={isDarkMode} />
                                </div>
                            </div>
                        ))}
                        {loading && <div className="text-xs opacity-50">Sta scrivendo...</div>}
                        <div ref={messagesEndRef} />
                    </div>
                    <div className={`p-4 border-t ${bgClass}`}>
                        <div className="flex gap-2">
                            <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} placeholder="Chiedi..." className={`w-full p-2 rounded border ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white'}`} />
                            <button onClick={handleSend}><Send className="w-5 h-5" /></button>
                        </div>
                    </div>
                </div>
            );
        };

        /* --- MAIN APP --- */
        function App() {
            const [isDarkMode, setIsDarkMode] = useState(() => {
                if (typeof window !== 'undefined') {
                    const saved = localStorage.getItem('isDarkMode');
                    return saved !== null ? JSON.parse(saved) : true;
                }
                return true;
            });
            
            const [apiKey, setApiKey] = useState(() => {
                if (typeof window !== 'undefined') {
                    return localStorage.getItem('geminiApiKey') || '';
                }
                return '';
            });
            
            useEffect(() => {
                localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
            }, [isDarkMode]);

            useEffect(() => {
                if (apiKey) {
                    localStorage.setItem('geminiApiKey', apiKey);
                }
            }, [apiKey]);
            
            const [inputMode, setInputMode] = useState('upload');
            const [image, setImage] = useState(null);
            const [loading, setLoading] = useState(false);
            const [result, setResult] = useState(null);
            const [error, setError] = useState('');
            const [showLiveTutor, setShowLiveTutor] = useState(false);
            const [showApiGuide, setShowApiGuide] = useState(false);
            const [showContacts, setShowContacts] = useState(false);
            const [showSettings, setShowSettings] = useState(true);
            const [textInput, setTextInput] = useState('');
            const [isListening, setIsListening] = useState(false);

            // Canvas & Camera Refs
            const canvasRef = useRef(null);
            const contextRef = useRef(null);
            const videoRef = useRef(null);
            const [isDrawing, setIsDrawing] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const recognitionRef = useRef(null);

            const ggbAppletRef = useRef(null);

            useEffect(() => {
                document.documentElement.classList.toggle('dark', isDarkMode);
            }, [isDarkMode]);

            const handleImageUpload = (e) => {
                const file = e.target.files[0];
                if (file) setImage(file);
            };

            // --- CAMERA LOGIC ---
            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
                    if(videoRef.current) videoRef.current.srcObject = stream;
                } catch (err) { setError("Errore Camera: " + err.message); }
            };

            const capturePhoto = () => {
                if (videoRef.current) {
                    const canvas = document.createElement('canvas');
                    canvas.width = videoRef.current.videoWidth;
                    canvas.height = videoRef.current.videoHeight;
                    canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
                    setCapturedImage(canvas.toDataURL('image/jpeg'));
                    const stream = videoRef.current.srcObject;
                    if(stream) stream.getTracks().forEach(t => t.stop());
                }
            };

            // --- CANVAS LOGIC ---
            useEffect(() => {
                if (inputMode === 'camera') startCamera();
                if (inputMode === 'draw') initCanvas();
            }, [inputMode, isDarkMode]);

            const initCanvas = () => {
                const canvas = canvasRef.current;
                if (!canvas) return;
                const dpr = window.devicePixelRatio || 1;
                const rect = canvas.parentElement.getBoundingClientRect();
                canvas.width = rect.width * dpr;
                canvas.height = 300 * dpr; 
                canvas.style.width = `${rect.width}px`;
                canvas.style.height = "300px";
                
                const ctx = canvas.getContext('2d');
                ctx.scale(dpr, dpr);
                ctx.lineCap = 'round';
                ctx.lineJoin = 'round';
                ctx.strokeStyle = isDarkMode ? '#FFFFFF' : '#000000';
                ctx.lineWidth = 4;
                contextRef.current = ctx;
            };

            const startDrawing = (e) => {
                const { offsetX, offsetY } = getCoordinates(e);
                contextRef.current.beginPath();
                contextRef.current.moveTo(offsetX, offsetY);
                setIsDrawing(true);
            };

            const draw = (e) => {
                if (!isDrawing) return;
                const { offsetX, offsetY } = getCoordinates(e);
                contextRef.current.lineTo(offsetX, offsetY);
                contextRef.current.stroke();
            };

            const finishDrawing = () => {
                contextRef.current.closePath();
                setIsDrawing(false);
            };

            const getCoordinates = (event) => {
                if (event.touches && event.touches[0]) {
                    const rect = canvasRef.current.getBoundingClientRect();
                    return {
                        offsetX: event.touches[0].clientX - rect.left,
                        offsetY: event.touches[0].clientY - rect.top
                    };
                }
                return { offsetX: event.nativeEvent.offsetX, offsetY: event.nativeEvent.offsetY };
            };

            const clearCanvas = () => {
                const canvas = canvasRef.current;
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            };

            // --- SPEECH RECOGNITION ---
            const toggleMic = () => {
                if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                    alert("Browser non supportato per la dettatura.");
                    return;
                }

                if (isListening) {
                    setIsListening(false);
                    if (recognitionRef.current) recognitionRef.current.stop();
                    return;
                }

                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                const recognition = new SpeechRecognition();
                recognition.lang = 'it-IT';
                recognition.continuous = false;
                recognition.interimResults = false;

                recognition.onstart = () => setIsListening(true);
                recognition.onend = () => setIsListening(false);
                recognition.onerror = (e) => { console.error(e); setIsListening(false); };
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    setTextInput(prev => prev + (prev ? ' ' : '') + transcript);
                };

                recognitionRef.current = recognition;
                recognition.start();
            };

            // --- MAIN SOLVER ---
            const solveMathProblem = async () => {
                if (!apiKey) { setError("Inserisci API Key"); return; }
                
                setLoading(true);
                setError('');
                setResult(null);
                
                try {
                    let base64 = null;
                    
                    if (inputMode === 'upload' && image) {
                        base64 = await new Promise((resolve) => {
                            const reader = new FileReader();
                            reader.onloadend = () => resolve(reader.result.split(',')[1]);
                            reader.readAsDataURL(image);
                        });
                    } else if (inputMode === 'camera' && capturedImage) {
                        base64 = capturedImage.split(',')[1];
                    } else if (inputMode === 'draw' && canvasRef.current) {
                        const canvas = canvasRef.current;
                        const tempCanvas = document.createElement('canvas');
                        tempCanvas.width = canvas.width;
                        tempCanvas.height = canvas.height;
                        const tCtx = tempCanvas.getContext('2d');
                        tCtx.fillStyle = '#FFFFFF';
                        tCtx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
                        if (isDarkMode) {
                            tCtx.globalCompositeOperation = 'difference';
                        } else {
                            tCtx.globalCompositeOperation = 'source-over';
                        }
                        tCtx.drawImage(canvas, 0, 0);
                        base64 = tempCanvas.toDataURL('image/jpeg').split(',')[1];
                    }

                    if (!base64 && !textInput) { throw new Error("Nessun input fornito"); }

                    const parts = [
                        { text: `Sei un tutor esperto. Risolvi il problema. 
                        FORMATO RISPOSTA:
                        Spiegazione passo passo...
                        ---SEPARATORE_GRAFICO---
                        y = x^2 (solo equazione, usa sintassi matematica standard: x^2 non x^{2})` },
                        ...(textInput ? [{ text: textInput }] : []),
                        ...(base64 ? [{ inlineData: { mimeType: "image/jpeg", data: base64 } }] : [])
                    ];

                    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ contents: [{ parts }] })
                    });

                    const data = await response.json();
                    if(data.error) throw new Error(data.error.message);

                    const text = data.candidates[0].content.parts[0].text;
                    const separator = "---SEPARATORE_GRAFICO---";
                    let solution = text;
                    let plotCmd = null;

                    if (text.includes(separator)) {
                        const splitted = text.split(separator);
                        solution = splitted[0].trim();
                        plotCmd = splitted[1].trim();
                    }

                    setResult({ solution, plotCmd });

                } catch (err) {
                    setError("Errore: " + err.message);
                } finally {
                    setLoading(false);
                }
            };

            // GeoGebra Effect
            useEffect(() => {
                if (result?.plotCmd && window.GGBApplet) {
                    const containerId = 'ggb-element';
                    if (!ggbAppletRef.current) {
                        const params = {
                            "appName": "graphing",
                            "width": 800,
                            "height": 500,
                            "showToolBar": false,
                            "borderColor": null,
                            "scaleContainerClass": "ggb-container",
                            "allowUpscale": true,
                            "appletOnLoad": (api) => plotFunction(api, result.plotCmd)
                        };
                        const applet = new window.GGBApplet(params, true);
                        applet.inject(containerId);
                        ggbAppletRef.current = applet;
                    } else {
                        if (window.ggbApplet && window.ggbApplet.evalCommand) {
                            plotFunction(window.ggbApplet, result.plotCmd);
                        }
                    }
                }
            }, [result]);

            const plotFunction = (api, rawCmd) => {
                try {
                    api.reset();
                    let cleanCmd = rawCmd.replace(/`/g, '').trim(); 
                    cleanCmd = cleanCmd.replace(/\\frac\s*{([^{}]*)}\s*{([^{}]*)}/g, '($1)/($2)');
                    cleanCmd = cleanCmd.replace(/[{}]/g, '').replace(/\\/g, '');
                    console.log("Plotting:", cleanCmd);
                    const label = api.evalCommandGetLabels(cleanCmd);
                    if (label) {
                        api.setColor(label, 79, 70, 229);
                        api.setLineThickness(label, 5);
                    } else if(cleanCmd.includes('=')) {
                        const rhs = cleanCmd.split('=')[1].trim();
                        const retryLabel = api.evalCommandGetLabels(rhs);
                        if(retryLabel) {
                            api.setColor(retryLabel, 79, 70, 229);
                            api.setLineThickness(retryLabel, 5);
                        }
                    }
                } catch(e) { console.error("GGB Plot Error:", e); }
            };

            const bgClass = isDarkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-900';
            const cardClass = isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-200';

            return (
                <div className={`min-h-screen font-sans p-4 transition-colors duration-300 ${bgClass} flex flex-col`}>
                    
                    {showApiGuide && <ApiKeyGuide onClose={() => setShowApiGuide(false)} isDarkMode={isDarkMode} />}
                    {showLiveTutor && <LiveTutorChat apiKey={apiKey} contextSolution={result?.solution} isDarkMode={isDarkMode} onClose={() => setShowLiveTutor(false)} />}

                    <div className="max-w-4xl mx-auto space-y-6 flex-1 w-full">
                        {/* HEADER */}
                        <header className={`flex flex-wrap justify-between items-center p-4 rounded-2xl shadow-sm border ${cardClass}`}>
                            <div className="flex items-center gap-3 w-full md:w-auto mb-4 md:mb-0">
                                <div className="bg-indigo-600 p-2 rounded-lg"><Calculator className="text-white w-6 h-6" /></div>
                                <div>
                                    <h1 className="text-xl font-bold flex flex-col md:flex-row md:items-center gap-1">
                                        MathGenius AI 
                                        <span className="text-sm font-normal opacity-60 md:ml-2">by AiWorldCenter (~pes)</span>
                                    </h1>
                                </div>
                            </div>
                            <div className="flex items-center gap-2 w-full md:w-auto justify-end">
                                <a href="https://buymeacoffee.com/Pietroes" target="_blank" className="p-2 bg-yellow-400 text-black rounded-full"><Coffee className="w-5 h-5" /></a>
                                <div className="relative">
                                    <button onClick={() => setShowContacts(!showContacts)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800"><LinkIcon className="w-5 h-5" /></button>
                                    {showContacts && (
                                        <div className={`absolute right-0 top-full mt-2 w-48 rounded-xl shadow-xl border overflow-hidden z-50 ${cardClass}`}>
                                            <a href="https://pixabay.com/users/pietro_e_s-35569158/" target="_blank" className="flex items-center gap-3 p-3 text-sm hover:bg-gray-100 dark:hover:bg-gray-800"><Globe className="w-4 h-4 text-green-500"/> Pixabay</a>
                                            <a href="https://youtube.com/@aimuse-mfa?si=N5sEfNmL0BxO_cdW" target="_blank" className="flex items-center gap-3 p-3 text-sm hover:bg-gray-100 dark:hover:bg-gray-800"><Youtube className="w-4 h-4 text-red-500"/> YouTube</a>
                                        </div>
                                    )}
                                </div>
                                <button onClick={() => setIsDarkMode(!isDarkMode)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800">{isDarkMode ? <Sun className="w-5 h-5"/> : <Moon className="w-5 h-5"/>}</button>
                                <button onClick={() => setShowSettings(!showSettings)} className="p-2 rounded-full hover:bg-gray-200 dark:hover:bg-gray-800"><Settings className="w-5 h-5"/></button>
                            </div>
                        </header>

                        {/* CONFIG PANEL */}
                        {showSettings && (
                            <div className={`p-6 rounded-2xl shadow-sm border ${cardClass}`}>
                                <h3 className="font-semibold mb-2">Configurazione</h3>
                                <div className="flex gap-2">
                                    <input type="password" value={apiKey} onChange={e => setApiKey(e.target.value)} placeholder="Incolla API Key..." className="w-full p-2 rounded border bg-transparent" />
                                    <button onClick={() => setShowApiGuide(true)} className="p-2 border rounded"><HelpCircle className="w-5 h-5 text-indigo-500"/></button>
                                </div>
                            </div>
                        )}

                        <div className="grid md:grid-cols-2 gap-6">
                            {/* INPUT */}
                            <div className={`p-6 rounded-2xl shadow-sm border ${cardClass}`}>
                                <h2 className="font-bold mb-4">1. Inserisci Problema</h2>
                                <div className="flex gap-2 mb-4">
                                    <button onClick={() => setInputMode('upload')} className={`flex-1 p-2 rounded text-sm ${inputMode==='upload' ? 'bg-indigo-600 text-white' : 'border'}`}><Upload className="inline w-4 h-4 mr-1"/> Upload</button>
                                    <button onClick={() => setInputMode('camera')} className={`flex-1 p-2 rounded text-sm ${inputMode==='camera' ? 'bg-indigo-600 text-white' : 'border'}`}><Camera className="inline w-4 h-4 mr-1"/> Foto</button>
                                    <button onClick={() => setInputMode('draw')} className={`flex-1 p-2 rounded text-sm ${inputMode==='draw' ? 'bg-indigo-600 text-white' : 'border'}`}><PenTool className="inline w-4 h-4 mr-1"/> Disegna</button>
                                </div>

                                {inputMode === 'upload' && (
                                    <div className="border-2 border-dashed p-8 rounded-xl text-center relative hover:bg-gray-50 dark:hover:bg-gray-900">
                                        <input type="file" onChange={handleImageUpload} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer" />
                                        {image ? <div className="text-green-500">{image.name}</div> : <ImageIcon className="mx-auto w-10 h-10 opacity-50" />}
                                        {!image && <p className="text-sm mt-2 opacity-70">Clicca per caricare</p>}
                                    </div>
                                )}

                                {inputMode === 'camera' && (
                                    <div className="relative rounded-xl overflow-hidden bg-black aspect-video flex items-center justify-center">
                                        {!capturedImage ? (
                                            <>
                                                <video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover"></video>
                                                <button onClick={capturePhoto} className="absolute bottom-4 w-12 h-12 bg-white rounded-full border-4 border-indigo-500 z-10"></button>
                                            </>
                                        ) : (
                                            <>
                                                <img src={capturedImage} className="w-full h-full object-contain" />
                                                <button onClick={() => {setCapturedImage(null); startCamera();}} className="absolute bottom-4 px-4 py-2 bg-slate-800 text-white rounded-full flex items-center gap-2"><RefreshCw className="w-4 h-4"/> Riprova</button>
                                            </>
                                        )}
                                    </div>
                                )}

                                {inputMode === 'draw' && (
                                    <div className={`relative rounded-xl overflow-hidden border touch-none h-64 ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200'}`}>
                                        <canvas 
                                            ref={canvasRef}
                                            onMouseDown={startDrawing}
                                            onMouseUp={finishDrawing}
                                            onMouseMove={draw}
                                            onMouseLeave={finishDrawing}
                                            onTouchStart={startDrawing}
                                            onTouchEnd={finishDrawing}
                                            onTouchMove={draw}
                                            className="w-full h-full cursor-crosshair"
                                        />
                                        <button onClick={clearCanvas} className="absolute top-2 right-2 p-2 bg-red-500/10 text-red-500 rounded"><Eraser className="w-4 h-4"/></button>
                                    </div>
                                )}

                                {/* TEXT INPUT ALWAYS VISIBLE */}
                                <div className="relative mt-4">
                                    <textarea value={textInput} onChange={e => setTextInput(e.target.value)} placeholder="Aggiungi dettagli o scrivi il problema..." className="w-full h-24 p-3 rounded border bg-transparent" />
                                    <button onClick={() => {if(!isListening) toggleMic();}} className="absolute right-2 bottom-2 p-2 hover:bg-gray-100 dark:hover:bg-gray-800 rounded"><Mic className={`w-5 h-5 ${isListening ? 'text-red-500 animate-pulse' : ''}`}/></button>
                                </div>

                                <button onClick={solveMathProblem} disabled={loading} className="w-full mt-4 py-3 bg-indigo-600 text-white rounded-xl font-bold flex justify-center items-center gap-2 hover:bg-indigo-700 disabled:opacity-50">
                                    {loading ? <Loader2 className="animate-spin"/> : <Play className="w-5 h-5"/>} Risolvi
                                </button>
                                {error && <div className="mt-4 text-red-500 text-sm bg-red-100 dark:bg-red-900/30 p-2 rounded">{error}</div>}
                            </div>

                            {/* OUTPUT */}
                            <div className="space-y-6">
                                <div className={`p-6 rounded-2xl shadow-sm border min-h-[200px] ${cardClass}`}>
                                    <div className="flex justify-between items-center mb-4">
                                        <h2 className="font-bold">2. Soluzione</h2>
                                        {result && <button onClick={() => setShowLiveTutor(true)} className="text-indigo-500 flex items-center gap-1 text-sm font-bold"><MessageSquare className="w-4 h-4"/> Chiedi al Tutor</button>}
                                    </div>
                                    <div className="prose prose-sm dark:prose-invert">
                                        {result ? <SolutionDisplay content={result.solution} isDarkMode={isDarkMode}/> : <p className="opacity-50 italic text-center py-10">La soluzione apparirà qui...</p>}
                                    </div>
                                </div>

                                <div className={`p-1 rounded-2xl shadow-sm border overflow-hidden ${cardClass}`}>
                                    <div className="p-4 border-b border-gray-100 dark:border-gray-800"><h2 className="font-bold">3. Grafico</h2></div>
                                    <div className="relative w-full h-[400px] bg-white">
                                        <div id="ggb-element"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <footer className="mt-12 py-6 text-center text-xs opacity-50 border-t border-gray-200 dark:border-gray-800">
                        <p>Realizzato con l'aiuto dell'Intelligenza Artificiale.</p>
                    </footer>
                </div>
            );
        }

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>