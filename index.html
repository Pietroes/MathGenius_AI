import React, { useState, useEffect, useRef } from 'react';
import { 
  Upload, Image as ImageIcon, Loader2, Play, Settings, Calculator, 
  CheckCircle, AlertCircle, Moon, Sun, Camera, Mic, PenTool, 
  X, RefreshCw, Eraser, MessageSquare, Send, ChevronDown, ChevronUp, 
  User, Bot, HelpCircle, ExternalLink, Key, XCircle, Coffee, Youtube, 
  Globe, Link as LinkIcon, ShieldCheck
} from 'lucide-react';

/* --- UTILITIES --- */

const SolutionDisplay = ({ content, isDarkMode }) => {
  const containerRef = useRef(null);
  const [libsLoaded, setLibsLoaded] = useState(false);

  useEffect(() => {
    const loadLibraries = async () => {
      try {
        const loadScript = (src) => new Promise((resolve, reject) => {
           if (document.querySelector(`script[src="${src}"]`)) return resolve();
           const script = document.createElement('script');
           script.src = src;
           script.async = true;
           script.onload = resolve;
           script.onerror = reject;
           document.head.appendChild(script);
        });

        const loadCSS = (href) => {
          if (document.querySelector(`link[href="${href}"]`)) return;
          const link = document.createElement('link');
          link.rel = 'stylesheet';
          link.href = href;
          document.head.appendChild(link);
        };

        loadCSS('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css');
        await Promise.all([
          loadScript('https://cdn.jsdelivr.net/npm/marked/marked.min.js'),
          loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js')
        ]);
        await loadScript('https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/contrib/auto-render.min.js');
        setLibsLoaded(true);
      } catch (e) { console.error(e); }
    };
    loadLibraries();
  }, []);

  useEffect(() => {
    if (libsLoaded && content && window.marked && window.renderMathInElement && containerRef.current) {
      const mathBlocks = [];
      const protectedContent = content.replace(
        /\$\$([\s\S]*?)\$\$|\$((?:\\.|[^$])*)\$|\\\[([\s\S]*?)\\\]|\\\(([\s\S]*?)\\\)/g, 
        (match) => {
          const id = mathBlocks.length;
          mathBlocks.push(match);
          return `MATHBLOCKPLACEHOLDER${id}ENDMATHBLOCK`; 
        }
      );
      let htmlContent = window.marked.parse(protectedContent);
      htmlContent = htmlContent.replace(/MATHBLOCKPLACEHOLDER(\d+)ENDMATHBLOCK/g, (match, id) => mathBlocks[parseInt(id)]);
      containerRef.current.innerHTML = htmlContent;
      window.renderMathInElement(containerRef.current, {
        delimiters: [
          { left: '$$', right: '$$', display: true },
          { left: '$', right: '$', display: false },
          { left: '\\(', right: '\\)', display: false },
          { left: '\\[', right: '\\]', display: true }
        ],
        throwOnError: false
      });
    }
  }, [libsLoaded, content]);

  if (!content) return null;
  const themeClasses = isDarkMode 
    ? "prose-invert prose-p:text-slate-300 prose-headings:text-slate-100 prose-strong:text-indigo-400 prose-li:text-slate-300 prose-code:text-indigo-300" 
    : "prose-headings:text-slate-800 prose-p:text-slate-600 prose-strong:text-indigo-700 prose-li:text-slate-600 prose-code:text-indigo-600";
  return <div ref={containerRef} className={`prose prose-sm max-w-none break-words overflow-x-auto ${themeClasses}`} />;
};

/* --- API KEY GUIDE COMPONENT --- */

const ApiKeyGuide = ({ onClose, isDarkMode }) => {
  // CONFIGURAZIONE IMMAGINI: Incolla qui i tuoi link RAW di GitHub
  const steps = [
    { 
      title: "1. Accesso a Google AI Studio", 
      desc: "Vai su aistudio.google.com con il tuo account Google.", 
      icon: <ExternalLink className="w-10 h-10 text-indigo-500" />,
      // Esempio: "https://raw.githubusercontent.com/Pietroes/MathGenius/main/img/step1.png"
      img: "https://raw.githubusercontent.com/Pietroes/MathGenius_AI/refs/heads/main/1tutorial-2.jpg" 
    },
    { 
      title: "2. Ottieni Chiave", 
      desc: "Clicca su 'Get API key' nel menu laterale.", 
      icon: <Key className="w-10 h-10 text-indigo-500" />,
      img: "https://raw.githubusercontent.com/Pietroes/MathGenius_AI/refs/heads/main/2tutorial-2.jpg" 
    },
    { 
      title: "3. Crea Chiave", 
      desc: "Premi 'Create API key'.", 
      icon: <Play className="w-10 h-10 text-indigo-500" />,
      img: "https://raw.githubusercontent.com/Pietroes/MathGenius_AI/refs/heads/main/3tutorial-2.jpg" 
    },
    { 
      title: "4. Nuovo Progetto", 
      desc: "Seleziona 'Create API key in new project'.", 
      icon: <Settings className="w-10 h-10 text-indigo-500" />,
      img: "https://raw.githubusercontent.com/Pietroes/MathGenius_AI/refs/heads/main/4tutorial-2.jpg" 
    },
    { 
      title: "5. Copia", 
      desc: "Copia la stringa generata e incollala qui.", 
      icon: <CheckCircle className="w-10 h-10 text-indigo-500" />,
      img: "https://raw.githubusercontent.com/Pietroes/MathGenius_AI/refs/heads/main/5tutorial-2.jpg" 
    }
  ];

  return (
    <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm animate-in fade-in duration-200">
      <div className={`w-full max-w-lg max-h-[85vh] overflow-y-auto rounded-2xl shadow-2xl flex flex-col ${isDarkMode ? 'bg-slate-900 text-white' : 'bg-white text-slate-900'}`}>
        <div className={`p-5 border-b sticky top-0 z-10 flex justify-between items-center ${isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-100'}`}>
          <h2 className="text-xl font-bold flex items-center gap-2"><Key className="w-5 h-5 text-indigo-500" /> Guida API Key</h2>
          <button onClick={onClose} className="p-2 rounded-full hover:bg-white/10"><X className="w-6 h-6" /></button>
        </div>
        <div className="p-6 space-y-8">
          <div className={`p-4 rounded-xl text-sm border flex gap-3 ${isDarkMode ? 'bg-indigo-900/20 border-indigo-500/30 text-indigo-200' : 'bg-indigo-50 border-indigo-100 text-indigo-700'}`}>
            <HelpCircle className="w-5 h-5 shrink-0 mt-0.5" />
            <p><strong>Nota:</strong> L'uso è gratuito.</p>
          </div>
          <div className="space-y-10">
            {steps.map((step, idx) => (
              <div key={idx} className="flex gap-4">
                <div className="flex-col items-center gap-2 hidden sm:flex">
                   <div className={`w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shrink-0 ${isDarkMode ? 'bg-indigo-600 text-white' : 'bg-indigo-100 text-indigo-700'}`}>{idx + 1}</div>
                   {idx < steps.length - 1 && <div className="w-0.5 h-full bg-slate-200 dark:bg-slate-700 my-1"></div>}
                </div>
                <div className="flex-1 space-y-3">
                  <div>
                    <h3 className="font-semibold">{step.title}</h3>
                    <p className={`text-sm ${isDarkMode ? 'text-slate-400' : 'text-slate-600'}`}>{step.desc}</p>
                  </div>
                  
                  {/* Image Display Logic */}
                  <div className={`rounded-lg border-2 border-dashed overflow-hidden ${isDarkMode ? 'border-slate-700 bg-slate-800/50' : 'border-slate-200 bg-slate-50'}`}>
                     {step.img ? (
                       <img src={step.img} alt={step.title} className="w-full h-auto object-cover" loading="lazy" />
                     ) : (
                       <div className="aspect-video flex flex-col items-center justify-center opacity-50">
                          {step.icon}
                          <span className="text-xs mt-2">Immagine Passo {idx + 1}</span>
                       </div>
                     )}
                  </div>
                </div>
              </div>
            ))}
          </div>
          <div className="pt-4 flex justify-center sticky bottom-0 bg-gradient-to-t from-slate-900 via-slate-900 to-transparent pb-4">
            <a href="https://aistudio.google.com/app/apikey" target="_blank" rel="noopener noreferrer" className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-6 py-3 rounded-full font-medium transition-colors shadow-lg shadow-indigo-500/30">Vai su Google AI Studio <ExternalLink className="w-4 h-4" /></a>
          </div>
        </div>
      </div>
    </div>
  );
};

/* --- LIVE TUTOR CHAT COMPONENT --- */

const LiveTutorChat = ({ apiKey, contextSolution, isDarkMode, onClose }) => {
  const [messages, setMessages] = useState([{ role: 'assistant', text: 'Ciao! Sono il tuo Tutor. Chiedimi pure!' }]);
  const [inputText, setInputText] = useState('');
  const [loading, setLoading] = useState(false);
  const [showContext, setShowContext] = useState(false); 
  const messagesEndRef = useRef(null);

  useEffect(() => { messagesEndRef.current?.scrollIntoView({ behavior: 'smooth' }); }, [messages, loading]);

  const handleSend = async () => {
    if (!inputText.trim()) return;
    const userMsg = inputText;
    setInputText('');
    setMessages(prev => [...prev, { role: 'user', text: userMsg }]);
    setLoading(true);
    try {
      if (!apiKey) throw new Error("API Key mancante.");
      const conversationHistory = messages.map(m => `${m.role === 'user' ? 'Studente' : 'Tutor'}: ${m.text}`).join('\n');
      const prompt = `Sei un tutor di matematica. CONTESTO: ${contextSolution} STORICO: ${conversationHistory} DOMANDA: ${userMsg} Rispondi chiaramente.`;
      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await response.json();
      if (data.error) throw new Error(data.error.message);
      const aiText = data.candidates?.[0]?.content?.parts?.[0]?.text;
      setMessages(prev => [...prev, { role: 'assistant', text: aiText || "Risposta vuota." }]);
    } catch (error) {
      setMessages(prev => [...prev, { role: 'assistant', text: `Errore: ${error.message}` }]);
    } finally {
      setLoading(false);
    }
  };

  const bgClass = isDarkMode ? 'bg-slate-900 border-slate-700' : 'bg-white border-slate-200';
  return (
    <div className={`fixed inset-0 z-50 flex flex-col md:max-w-md md:left-auto md:right-0 md:shadow-2xl animate-in slide-in-from-bottom-10 md:slide-in-from-right-10 duration-300 ${isDarkMode ? 'bg-slate-950 text-white' : 'bg-slate-50 text-slate-900'}`}>
      <div className={`flex items-center justify-between p-4 border-b ${bgClass}`}>
        <div className="flex items-center gap-2"><div className="p-2 bg-indigo-500/20 rounded-lg"><MessageSquare className="w-5 h-5 text-indigo-500" /></div><h3 className="font-bold">Tutor Chat</h3></div>
        <button onClick={onClose} className="p-2 rounded-full hover:bg-opacity-20"><X className="w-5 h-5" /></button>
      </div>
      <div className={`border-b ${bgClass}`}>
        <button onClick={() => setShowContext(!showContext)} className="w-full flex items-center justify-between p-3 text-sm font-medium opacity-70 hover:opacity-100">
          <span>{showContext ? 'Nascondi Soluzione' : 'Vedi Soluzione'}</span>{showContext ? <ChevronUp className="w-4 h-4" /> : <ChevronDown className="w-4 h-4" />}
        </button>
        {showContext && <div className={`p-4 max-h-48 overflow-y-auto text-sm border-t ${bgClass}`}><SolutionDisplay content={contextSolution} isDarkMode={isDarkMode} /></div>}
      </div>
      <div className="flex-1 overflow-y-auto p-4 space-y-4">
        {messages.map((msg, idx) => (
          <div key={idx} className={`flex gap-3 ${msg.role === 'user' ? 'justify-end' : 'justify-start'}`}>
            <div className={`max-w-[85%] p-3 rounded-2xl text-sm shadow-sm ${msg.role === 'user' ? 'bg-indigo-600 text-white rounded-br-none' : (isDarkMode ? 'bg-slate-800 rounded-bl-none' : 'bg-white rounded-bl-none')}`}>
              <SolutionDisplay content={msg.text} isDarkMode={isDarkMode} />
            </div>
          </div>
        ))}
        {loading && <div className="flex justify-start"><div className={`p-4 rounded-2xl rounded-bl-none flex gap-2 items-center ${isDarkMode ? 'bg-slate-800' : 'bg-white'}`}><div className="w-2 h-2 bg-current opacity-60 rounded-full animate-bounce"></div></div></div>}
        <div ref={messagesEndRef} />
      </div>
      <div className={`p-4 border-t ${bgClass}`}>
        <div className="flex gap-2 relative">
          <input type="text" value={inputText} onChange={(e) => setInputText(e.target.value)} onKeyDown={(e) => e.key === 'Enter' && handleSend()} placeholder="Chiedi spiegazioni..." className={`w-full p-3 pr-12 rounded-xl border outline-none focus:ring-2 focus:ring-indigo-500 transition-colors ${isDarkMode ? 'bg-slate-950 border-slate-700' : 'bg-white border-slate-200'}`} />
          <button onClick={handleSend} disabled={!inputText.trim() || loading} className="absolute right-2 top-1/2 -translate-y-1/2 p-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 disabled:opacity-50"><Send className="w-4 h-4" /></button>
        </div>
      </div>
    </div>
  );
};

/* --- MAIN APP --- */

export default function App() {
  const [isDarkMode, setIsDarkMode] = useState(() => {
    if (typeof window !== 'undefined') {
      const saved = localStorage.getItem('isDarkMode');
      return saved !== null ? JSON.parse(saved) : true;
    }
    return true;
  });
  
  const [apiKey, setApiKey] = useState(() => {
    if (typeof window !== 'undefined') {
      return localStorage.getItem('geminiApiKey') || '';
    }
    return '';
  });
  
  useEffect(() => {
    localStorage.setItem('isDarkMode', JSON.stringify(isDarkMode));
  }, [isDarkMode]);

  useEffect(() => {
    if (apiKey) {
      localStorage.setItem('geminiApiKey', apiKey);
    }
  }, [apiKey]);
  
  const [inputMode, setInputMode] = useState('upload');
  const [image, setImage] = useState(null); 
  const [capturedImage, setCapturedImage] = useState(null); 
  const [textInput, setTextInput] = useState('');
  
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null); 
  const [error, setError] = useState('');
  const [showSettings, setShowSettings] = useState(true);
  const [isListening, setIsListening] = useState(false);
  
  const [showLiveTutor, setShowLiveTutor] = useState(false);
  const [showApiGuide, setShowApiGuide] = useState(false);
  const [showContacts, setShowContacts] = useState(false);

  const ggbContainerRef = useRef(null);
  const ggbAppletRef = useRef(null);
  const videoRef = useRef(null);
  const canvasRef = useRef(null); 
  const streamRef = useRef(null);

  // --- GeoGebra Loader ---
  useEffect(() => {
    if (!document.getElementById('geogebra-loader')) {
      const script = document.createElement('script');
      script.id = 'geogebra-loader';
      script.src = 'https://www.geogebra.org/apps/deployggb.js';
      script.async = true;
      script.onload = () => console.log("GGB Loaded");
      document.body.appendChild(script);
    }
    return () => stopCamera();
  }, []);

  // --- GeoGebra Plotter Logic ---
  useEffect(() => {
    if (result?.plotCmd && window.GGBApplet && ggbContainerRef.current) {
        if (!ggbAppletRef.current) {
             const params = {
                "appName": "graphing",
                "width": 800,
                "height": 500,
                "showToolBar": false,
                "showAlgebraInput": false,
                "showMenuBar": false,
                "scaleContainerClass": "ggb-container",
                "allowUpscale": true,
                "autoHeight": false,
                "borderColor": null,
            };
            const applet = new window.GGBApplet(params, true);
            applet.inject('ggb-element');
            ggbAppletRef.current = applet;
        }
        let attempts = 0;
        const checkApplet = setInterval(() => {
            if (window.ggbApplet && typeof window.ggbApplet.evalCommandGetLabels === 'function') {
                clearInterval(checkApplet);
                try {
                    const applet = window.ggbApplet;
                    applet.reset();
                    let cleanEq = result.plotCmd.replace(/`/g, '').trim();
                    cleanEq = cleanEq.replace(/^[\*\-\d\.]+\s*/, ''); 
                    console.log(`Plotting: ${cleanEq}`);
                    const labelsStr = applet.evalCommandGetLabels(cleanEq);
                    if (labelsStr) {
                        const labels = labelsStr.split(',');
                        labels.forEach(label => {
                            applet.setColor(label, 79, 70, 229);
                            applet.setLineThickness(label, 5);
                        });
                    } else {
                        console.warn("GeoGebra failed to plot:", cleanEq);
                    }
                } catch(e) { console.error("GGB Error during plotting:", e); }
            }
            attempts++;
            if (attempts > 50) clearInterval(checkApplet);
        }, 100);
    }
  }, [result]);

  // --- Camera & Drawing Logic ---
  const startCamera = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
      videoRef.current.srcObject = stream;
      streamRef.current = stream;
    } catch (err) {
      setError("Impossibile accedere alla fotocamera. Controlla i permessi.");
    }
  };

  const stopCamera = () => {
    if (streamRef.current) {
      streamRef.current.getTracks().forEach(track => track.stop());
      streamRef.current = null;
    }
  };

  const capturePhoto = () => {
    if (videoRef.current) {
      const canvas = document.createElement('canvas');
      canvas.width = videoRef.current.videoWidth;
      canvas.height = videoRef.current.videoHeight;
      canvas.getContext('2d').drawImage(videoRef.current, 0, 0);
      const dataUrl = canvas.toDataURL('image/jpeg');
      setCapturedImage(dataUrl);
      stopCamera();
    }
  };

  const retakePhoto = () => {
    setCapturedImage(null);
    startCamera();
  };

  const [isDrawing, setIsDrawing] = useState(false);
  const contextRef = useRef(null);

  const initCanvas = () => {
    const canvas = canvasRef.current;
    if (!canvas) return;
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = 300 * dpr; 
    canvas.style.width = `${rect.width}px`;
    canvas.style.height = "300px";
    const ctx = canvas.getContext('2d');
    ctx.scale(dpr, dpr);
    ctx.lineCap = 'round';
    ctx.lineJoin = 'round';
    ctx.strokeStyle = isDarkMode ? '#FFFFFF' : '#000000';
    ctx.lineWidth = 6; 
    contextRef.current = ctx;
  };

  useEffect(() => {
    if (inputMode === 'draw') {
        setTimeout(initCanvas, 100); 
    }
  }, [inputMode, isDarkMode]);

  const startDrawing = ({ nativeEvent }) => {
    if(!contextRef.current) return;
    const { offsetX, offsetY } = getCoordinates(nativeEvent);
    contextRef.current.beginPath();
    contextRef.current.moveTo(offsetX, offsetY);
    setIsDrawing(true);
  };

  const finishDrawing = () => {
    if(!contextRef.current) return;
    contextRef.current.closePath();
    setIsDrawing(false);
  };

  const draw = ({ nativeEvent }) => {
    if (!isDrawing || !contextRef.current) return;
    const { offsetX, offsetY } = getCoordinates(nativeEvent);
    contextRef.current.lineTo(offsetX, offsetY);
    contextRef.current.stroke();
  };

  const getCoordinates = (event) => {
    if (event.touches && event.touches[0]) {
      const rect = canvasRef.current.getBoundingClientRect();
      return {
        offsetX: event.touches[0].clientX - rect.left,
        offsetY: event.touches[0].clientY - rect.top
      };
    }
    return { offsetX: event.nativeEvent ? event.nativeEvent.offsetX : event.offsetX, offsetY: event.nativeEvent ? event.nativeEvent.offsetY : event.offsetY };
  };

  const clearCanvas = () => {
    const canvas = canvasRef.current;
    if(canvas) {
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }
  };

  const toggleMic = () => {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
      alert("Il tuo browser non supporta il riconoscimento vocale.");
      return;
    }
    if (isListening) {
      setIsListening(false);
      return;
    }
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.lang = 'it-IT';
    recognition.continuous = false;
    recognition.interimResults = false;
    recognition.onstart = () => setIsListening(true);
    recognition.onend = () => setIsListening(false);
    recognition.onresult = (event) => {
      const transcript = event.results[0][0].transcript;
      setTextInput(prev => prev + (prev ? ' ' : '') + transcript);
    };
    recognition.onerror = (event) => {
        console.error(event.error);
        setIsListening(false);
    };
    recognition.start();
  };

  const solveMathProblem = async () => {
    if (!apiKey) {
      setError("Inserisci la tua API Key di Google Gemini per continuare.");
      setShowSettings(true);
      return;
    }
    let finalImageBase64 = null;
    if (inputMode === 'upload' && image) {
        finalImageBase64 = await new Promise((resolve) => {
            const reader = new FileReader();
            reader.onloadend = () => resolve(reader.result.split(',')[1]);
            reader.readAsDataURL(image);
        });
    } else if (inputMode === 'camera' && capturedImage) {
        finalImageBase64 = capturedImage.split(',')[1];
    } else if (inputMode === 'draw') {
        const canvas = canvasRef.current;
        if(canvas) {
            const tempCanvas = document.createElement('canvas');
            tempCanvas.width = canvas.width;
            tempCanvas.height = canvas.height;
            const ctx = tempCanvas.getContext('2d');
            ctx.fillStyle = '#FFFFFF';
            ctx.fillRect(0, 0, tempCanvas.width, tempCanvas.height);
            if (isDarkMode) {
                ctx.globalCompositeOperation = 'difference';
            } else {
                ctx.globalCompositeOperation = 'source-over';
            }
            ctx.drawImage(canvas, 0, 0);
            finalImageBase64 = tempCanvas.toDataURL('image/jpeg', 0.9).split(',')[1];
        }
    }

    if (!finalImageBase64 && !textInput.trim()) {
      setError("Inserisci almeno un'immagine o del testo per procedere.");
      return;
    }
    setLoading(true);
    setError('');
    setResult(null);

    try {
      const parts = [];
      const systemPrompt = `
        Sei un tutor di matematica esperto. 
        Analizza l'immagine o il testo fornito.
        Compiti:
        1. Risolvi il problema passo dopo passo in Italiano. Usa Markdown e LaTeX.
        2. Se il problema è una funzione o un'equazione graficabile, estrai l'equazione finale per GeoGebra.
        FORMATO RISPOSTA (IMPORTANTE):
        Usa ESATTAMENTE la stringa "---SEPARATORE_GRAFICO---" per dividere la soluzione dal comando grafico.
        Dopo il separatore, scrivi SOLO l'equazione da graficare.
      `;
      parts.push({ text: systemPrompt });
      if (textInput) parts.push({ text: `TESTO UTENTE: ${textInput}` });
      if (finalImageBase64) parts.push({ inlineData: { mimeType: "image/jpeg", data: finalImageBase64 } });

      const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts }] })
      });
      const data = await response.json();
      if (data.error) throw new Error(data.error.message);

      const textResponse = data.candidates[0].content.parts[0].text;
      const separator = "---SEPARATORE_GRAFICO---";
      let solution = "";
      let plotCmd = null;

      if (textResponse.includes(separator)) {
          const parts = textResponse.split(separator);
          solution = parts[0].trim();
          const rawPlot = parts[1].trim();
          if (rawPlot && rawPlot.length > 0 && rawPlot.toLowerCase() !== 'null') {
              plotCmd = rawPlot;
          }
      } else {
          solution = textResponse.trim();
      }
      solution = solution.replace(/\[SOLUZIONE\]/gi, '').trim();
      setResult({ solution, plotCmd });
    } catch (err) {
      setError(`Errore: ${err.message || "Impossibile elaborare la richiesta"}`);
    } finally {
      setLoading(false);
    }
  };

  const handleModeChange = (mode) => {
    if (inputMode === 'camera' && mode !== 'camera') stopCamera();
    if (mode === 'camera') { setCapturedImage(null); startCamera(); }
    setInputMode(mode);
    setError('');
  };

  const bgMain = isDarkMode ? 'bg-slate-950 text-slate-100' : 'bg-slate-50 text-slate-800';
  const cardBg = isDarkMode ? 'bg-slate-900 border-slate-800' : 'bg-white border-slate-100';
  const textTitle = isDarkMode ? 'text-slate-100' : 'text-slate-900';
  const activeTabClass = isDarkMode ? 'bg-indigo-600 text-white shadow-lg shadow-indigo-500/20' : 'bg-indigo-600 text-white shadow-lg shadow-indigo-200';
  const inactiveTabClass = isDarkMode ? 'text-slate-400 hover:bg-slate-800' : 'text-slate-500 hover:bg-slate-100';

  return (
    <div className={`min-h-screen font-sans p-4 md:p-6 transition-colors duration-300 overflow-x-hidden ${bgMain} flex flex-col`}>
      
      {showLiveTutor && (
        <LiveTutorChat 
          apiKey={apiKey}
          contextSolution={result?.solution}
          isDarkMode={isDarkMode}
          onClose={() => setShowLiveTutor(false)}
        />
      )}

      {showApiGuide && (
        <ApiKeyGuide 
          onClose={() => setShowApiGuide(false)}
          isDarkMode={isDarkMode}
        />
      )}

      <div className="max-w-4xl mx-auto space-y-6 w-full flex-1">
        <header className={`flex flex-wrap justify-between items-center p-4 md:p-6 rounded-2xl shadow-sm border transition-colors ${cardBg}`}>
          <div className="flex items-center gap-3 w-full md:w-auto mb-4 md:mb-0">
            <div className="bg-indigo-600 p-2 rounded-lg shrink-0"><Calculator className="w-6 h-6 text-white" /></div>
            <div>
              <h1 className={`text-xl md:text-2xl font-bold ${textTitle} flex flex-col md:flex-row md:items-center gap-1`}>
                MathGenius AI 
                <span className="text-sm font-normal text-slate-400 md:ml-2">by AiWorldCenter (~pes)</span>
              </h1>
              <p className="text-sm opacity-60">Risolutore Multimodale</p>
            </div>
          </div>
          
          <div className="flex items-center gap-2 w-full md:w-auto justify-end">
             <a href="https://buymeacoffee.com/Pietroes" target="_blank" rel="noopener noreferrer" className="p-2 rounded-full bg-yellow-400 hover:bg-yellow-500 text-slate-900 transition-colors" title="Offrimi un caffè"><Coffee className="w-5 h-5" /></a>
             <div className="relative">
                <button onClick={() => setShowContacts(!showContacts)} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-slate-800 text-slate-300' : 'hover:bg-slate-100 text-slate-600'}`} title="I miei contatti"><LinkIcon className="w-5 h-5" /></button>
                {showContacts && (
                  <div className={`absolute right-0 top-full mt-2 w-48 rounded-xl shadow-xl border overflow-hidden z-50 animate-in fade-in zoom-in-95 duration-200 ${isDarkMode ? 'bg-slate-800 border-slate-700' : 'bg-white border-slate-100'}`}>
                    <a href="https://pixabay.com/users/pietro_e_s-35569158/" target="_blank" rel="noopener noreferrer" className={`flex items-center gap-3 p-3 text-sm transition-colors ${isDarkMode ? 'hover:bg-slate-700 text-slate-200' : 'hover:bg-slate-50 text-slate-700'}`}><Globe className="w-4 h-4 text-emerald-500" /> Pixabay</a>
                    <a href="https://youtube.com/@aimuse-mfa?si=N5sEfNmL0BxO_cdW" target="_blank" rel="noopener noreferrer" className={`flex items-center gap-3 p-3 text-sm transition-colors border-t ${isDarkMode ? 'border-slate-700 hover:bg-slate-700 text-slate-200' : 'border-slate-100 hover:bg-slate-50 text-slate-700'}`}><Youtube className="w-4 h-4 text-red-500" /> YouTube</a>
                  </div>
                )}
             </div>
             <div className={`w-px h-6 mx-1 ${isDarkMode ? 'bg-slate-700' : 'bg-slate-200'}`}></div>
             <button onClick={() => setIsDarkMode(!isDarkMode)} className={`p-2 rounded-full transition-colors ${isDarkMode ? 'hover:bg-slate-800' : 'hover:bg-slate-100'}`}>{isDarkMode ? <Sun className="w-5 h-5" /> : <Moon className="w-5 h-5" />}</button>
             <button onClick={() => setShowSettings(!showSettings)} className={`p-2 rounded-full transition-colors ${showSettings ? 'bg-indigo-500/10 text-indigo-500' : (isDarkMode ? 'hover:bg-slate-800' : 'hover:bg-slate-100')}`}><Settings className="w-5 h-5" /></button>
          </div>
        </header>

        {showSettings && (
          <div className={`p-6 rounded-2xl shadow-sm border animate-in slide-in-from-top-4 fade-in duration-300 ${cardBg}`}>
            <h3 className={`font-semibold mb-3 flex items-center gap-2 ${textTitle}`}><Settings className="w-4 h-4" /> Configurazione</h3>
            <div className="flex flex-col gap-2">
              <label className="text-sm opacity-70">Google Gemini API Key</label>
              <div className="flex gap-2">
                <input type="password" value={apiKey} onChange={(e) => setApiKey(e.target.value)} placeholder="Incolla qui la tua API Key..." className={`w-full p-3 border rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none font-mono text-sm transition-colors ${isDarkMode ? 'bg-slate-950 border-slate-700' : 'bg-white border-slate-200'}`} />
                <button onClick={() => setShowApiGuide(true)} className={`p-3 rounded-lg border flex items-center gap-2 shrink-0 ${isDarkMode ? 'bg-slate-800 border-slate-700 hover:bg-slate-700' : 'bg-slate-100 border-slate-200 hover:bg-slate-200'}`} title="Come ottenere la chiave?"><HelpCircle className="w-5 h-5 text-indigo-500" /></button>
              </div>
            </div>
          </div>
        )}

        <div className="grid md:grid-cols-2 gap-6 w-full">
          <div className={`p-6 rounded-2xl shadow-sm border h-fit transition-colors flex flex-col gap-4 ${cardBg}`}>
            <h2 className={`text-lg font-semibold ${textTitle}`}>1. Inserisci il Problema</h2>
            <div className={`flex flex-wrap gap-2 p-1 rounded-xl ${isDarkMode ? 'bg-slate-950' : 'bg-slate-100'}`}>
                <button onClick={() => handleModeChange('upload')} className={`flex-1 min-w-[80px] py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all ${inputMode === 'upload' ? activeTabClass : inactiveTabClass}`}><Upload className="w-4 h-4" /> Upload</button>
                <button onClick={() => handleModeChange('camera')} className={`flex-1 min-w-[80px] py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all ${inputMode === 'camera' ? activeTabClass : inactiveTabClass}`}><Camera className="w-4 h-4" /> Foto</button>
                <button onClick={() => handleModeChange('draw')} className={`flex-1 min-w-[80px] py-2 px-3 rounded-lg text-sm font-medium flex items-center justify-center gap-2 transition-all ${inputMode === 'draw' ? activeTabClass : inactiveTabClass}`}><PenTool className="w-4 h-4" /> Disegna</button>
            </div>

            <div className="min-h-[250px] relative">
                {inputMode === 'upload' && (
                    <div className={`h-full border-2 border-dashed rounded-xl p-6 flex flex-col items-center justify-center text-center transition-colors relative ${isDarkMode ? 'border-slate-700 hover:bg-slate-800/50' : 'border-slate-200 hover:bg-slate-50'}`}>
                        <input type="file" accept="image/*" onChange={(e) => {if(e.target.files[0]) setImage(e.target.files[0]);}} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                        {image ? (
                            <div className="w-full h-full flex flex-col items-center justify-center">
                                <img src={URL.createObjectURL(image)} className="max-h-[180px] rounded-lg shadow-sm mb-2" alt="Upload preview" />
                                <div className="text-emerald-500 text-sm flex items-center gap-1"><CheckCircle className="w-3 h-3"/> {image.name}</div>
                            </div>
                        ) : (
                            <><ImageIcon className={`w-10 h-10 mb-3 ${isDarkMode ? 'text-slate-600' : 'text-slate-300'}`} /><p className="text-sm font-medium opacity-70">Clicca o trascina un'immagine</p></>
                        )}
                    </div>
                )}
                {inputMode === 'camera' && (
                    <div className="h-full rounded-xl overflow-hidden relative bg-black flex items-center justify-center">
                        {!capturedImage ? (
                            <><video ref={videoRef} autoPlay playsInline muted className="w-full h-full object-cover" /><button onClick={capturePhoto} className="absolute bottom-4 left-1/2 -translate-x-1/2 w-14 h-14 bg-white rounded-full border-4 border-indigo-500 shadow-lg flex items-center justify-center active:scale-95 transition-transform z-20"><div className="w-10 h-10 bg-indigo-600 rounded-full"></div></button></>
                        ) : (
                            <><img src={capturedImage} alt="Captured" className="w-full h-full object-contain" /><button onClick={retakePhoto} className="absolute bottom-4 left-1/2 -translate-x-1/2 bg-slate-800/80 text-white px-4 py-2 rounded-full flex items-center gap-2 backdrop-blur-sm hover:bg-slate-800 transition-colors z-20"><RefreshCw className="w-4 h-4" /> Scatta di nuovo</button></>
                        )}
                    </div>
                )}
                {inputMode === 'draw' && (
                    <div className={`h-full border rounded-xl overflow-hidden relative touch-none ${isDarkMode ? 'border-slate-700 bg-slate-900' : 'border-slate-200 bg-white'}`}>
                        <canvas ref={canvasRef} onMouseDown={startDrawing} onMouseUp={finishDrawing} onMouseMove={draw} onMouseLeave={finishDrawing} onTouchStart={startDrawing} onTouchEnd={finishDrawing} onTouchMove={draw} style={{ touchAction: 'none' }} className="w-full h-full cursor-crosshair" />
                        <button onClick={clearCanvas} className="absolute top-2 right-2 p-2 rounded-lg bg-red-500/10 text-red-500 hover:bg-red-500/20 transition-colors" title="Cancella tutto"><Eraser className="w-4 h-4" /></button>
                    </div>
                )}
            </div>

            <div className="relative">
                <textarea value={textInput} onChange={(e) => setTextInput(e.target.value)} placeholder="Scrivi qui il problema..." className={`w-full p-4 pr-12 rounded-xl border resize-none h-24 focus:ring-2 focus:ring-indigo-500 outline-none transition-colors ${isDarkMode ? 'bg-slate-950 border-slate-700 placeholder:text-slate-600' : 'bg-slate-50 border-slate-200 placeholder:text-slate-400'}`} />
                <button onClick={toggleMic} className={`absolute right-3 top-3 p-2 rounded-lg transition-all duration-200 ${isListening ? 'bg-red-50 dark:bg-red-900/30 text-red-600 dark:text-red-400 ring-1 ring-red-500 animate-pulse shadow-sm' : 'text-slate-400 hover:bg-slate-200 dark:hover:bg-slate-800'}`} title={isListening ? "Interrompi ascolto" : "Attiva dettatura vocale"}><Mic className={`w-5 h-5 ${isListening ? 'fill-current' : ''}`} /></button>
            </div>

            <button onClick={solveMathProblem} disabled={loading || (!image && !capturedImage && !textInput && inputMode !== 'draw')} className={`w-full py-3 rounded-xl font-medium flex items-center justify-center gap-2 transition-all ${loading ? 'bg-slate-200 dark:bg-slate-800 text-slate-400 cursor-not-allowed' : 'bg-indigo-600 text-white hover:bg-indigo-700 shadow-lg shadow-indigo-500/20'}`}>
              {loading ? <><Loader2 className="w-5 h-5 animate-spin" /> Analisi...</> : <><Play className="w-5 h-5" /> Risolvi</>}
            </button>
            
            {error && <div className="p-3 bg-red-500/10 text-red-500 border border-red-500/20 rounded-lg text-sm flex items-start gap-2"><AlertCircle className="w-5 h-5 shrink-0" />{error}</div>}
          </div>

          <div className="space-y-6 w-full min-w-0">
            <div className={`p-6 rounded-2xl shadow-sm border min-h-[200px] transition-all duration-500 w-full ${cardBg} ${!result && 'opacity-50 blur-[1px]'}`}>
              <div className="flex justify-between items-center mb-4">
                <h2 className={`text-lg font-semibold ${textTitle}`}>2. Soluzione</h2>
                {result && (
                  <button onClick={() => setShowLiveTutor(true)} className="flex items-center gap-2 bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-full text-sm font-medium transition-colors shadow-lg shadow-indigo-500/20"><MessageSquare className="w-4 h-4" /> Chiedi al Tutor</button>
                )}
              </div>
              {result ? (<SolutionDisplay content={result.solution} isDarkMode={isDarkMode} />) : (<div className="h-full flex items-center justify-center opacity-40 italic">Il risultato apparirà qui...</div>)}
            </div>

            <div className={`p-1 rounded-2xl shadow-sm border overflow-hidden transition-all duration-500 w-full ${cardBg} ${!result && 'opacity-50 grayscale'}`}>
              <div className={`p-4 border-b mb-2 flex flex-col gap-2 ${isDarkMode ? 'border-slate-800' : 'border-slate-50'}`}>
                 <h2 className={`text-lg font-semibold ${textTitle}`}>3. Grafico Interattivo</h2>
                 {result?.plotCmd && (<span className="text-xs font-mono bg-indigo-500/10 text-indigo-500 px-2 py-1 rounded max-w-[250px] truncate ml-2">{result.plotCmd}</span>)}
              </div>
              <div className={`ggb-container relative w-full h-[450px] md:h-[500px] rounded-xl overflow-hidden ${isDarkMode ? 'bg-white' : 'bg-slate-50'}`} ref={ggbContainerRef}>
                <div id="ggb-element" className="w-full h-full"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <footer className="mt-12 py-6 text-center text-xs opacity-50 border-t border-slate-200 dark:border-slate-800">
        <p>Questo progetto è stato realizzato con l'aiuto dell'Intelligenza Artificiale.</p>
        <p className="mt-1 flex items-center justify-center gap-1">
           <ShieldCheck className="w-3 h-3" /> Conformità GDPR: Nessun tracciamento, solo cookie tecnici.
        </p>
      </footer>

    </div>
  );
}



